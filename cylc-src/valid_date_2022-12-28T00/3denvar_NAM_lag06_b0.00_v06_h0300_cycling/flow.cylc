#!jinja2
{################################################################################}
{# CONTROL FLOW NAME / TUNABLE SETTINGS #}
{################################################################################}
{# Define the valid date YYYY-MM-DDTHH for verification #}
{% set EXP_VRF = '2022-12-28T00' %}

{# Define the name of case study #}
{% set CSE_NME = ['valid_date', EXP_VRF] | join('_') %}

{# Define the lag of the ensemble simulation start time here in HH #}
{% set LAG = '06' %}

{# Define tuneable beta value for ensemble / static background hybridization here #}
{% set BETA = '0.00' %}

{# Define tuneable beta value for ensemble vertical localization scale here #}
{% set VLOC = '06' %}

{# Define tuneable value for ensemble horizontal localization scale here #}
{% set HLOC = '0300' %}

{# Configuration name including tunable parameters #}
{% set CFG_NME = ['NAM','lag', LAG,'b', BETA,'v', VLOC, 'h', HLOC] | join('_') %}

{# Case / configuration structure #}
{% set EXP_NME = [CSE_NME, CFG_NME] | join('/') %}

{################################################################################}
{# CYCLING SETTINGS #}
{################################################################################}
{# First initial time for first forecast (no DA) YYYY-MM-DDTHH #}
{# DA will begin on the next cycle determined by CYC_INC below #}
{% set CYC_STRT = '2022-12-19T18' %}

{# Last initial time for a forecast YYYY-MM-DDTHH #}
{% set CYC_STOP = '2022-12-28T00' %}

{# Interval between cycle start times INT hours value #}
{% set CYC_INC = 6 %}

{# Length of warmup period of full DA cycling before extended forecasts #}
{# Period begins after first forecast and excludes the final cylc point #}
{% set WRM_UP = 'P1D' %}

{# Fixed forecast length within every cycle INT hours >= CYC_INC #}
{% set FCST_HRS = 6 %}

{# List of zero hour to initialize extended forecasts (usually T00 / T12) #}
{% set EXT_ZHRS = [ 'T00' ] %}

{# First cycle to initialize extended forecast for verifcation at valid date #}
{% set VRF_STRT = '2022-12-23T00' %}

{# Last cycle to  initialize extended forecast for verification at valid date #}
{% set VRF_STOP = '2022-12-27T00' %}

{# Interval between cycle start times PTXXH #}
{% set VRF_INC = 'PT24H' %}

{################################################################################}
{# WRF SETTINGS #}
{################################################################################}
{# Min domain index to have ICs downscaled from d01 for forecast validation #}
{% set VRF_FOR_DOM= '02' %}

{# GFS and GEFS currently supported for 3D-(En)VAR #}
{% set CTR_BKG_DATA= 'GEFS' %}

{# Data file frequency for control simulation forcing in HH #}
{% set CTR_BKG_INT= '03' %}

{# Max domain for control cycling simulation #}
{% set CTR_CYC_DOM= '01' %}

{# Max domain for control extended forecast simulation #}
{% set CTR_FOR_DOM= '02' %}

#{# Static ensemble perturbations stored here organized by lag length #}
# set WRF_ENS_ROOT= '{{environ['DATA_ROOT']}}/ensembles/lag{{LAG}}'

{# Max domain for ensemble simulation #}
{% set WRF_ENS_DOM= '01' %}

{# Output interval for history files in HH, suppressed = 00 #}
{% set HIST_INT = '03' %}

{# Output interval for restart files in HH, suppressed = 00 #}
{# Automatically set the restart interval to the forecast length = 'END' #}
{% set RSTRT_INT = 'END' %}

{# This setting defines Yes / No for nested domain 2-way coupling #}
{% set IF_FEEDBACK = 'No' %}

{# Lower boundary condition updates from background data #}
{% set IF_SST_UPDT = 'No' %}

{# Quilting tasks per group, set NIO_TPG=0 for default TURN OFF QUILTING #}
{% set NIO_TPG = 0 %}

{# Quilting number of groups #}
{% set NIO_GRPS = 4 %}

{################################################################################}
{# GSI SETTINGS #}
{################################################################################}
{# Uses ensemble-based covariance Yes / No #}
{% set IF_HYBRID  = 'Yes' %}

{# Max loop index to iterate GSI variational bias correction files #}
{# NOTE: loop 0 is uses GDAS global files #}
{% set MAX_BC_LOOP= '02' %}

{################################################################################}
{# ENSEMBLE SETTINGS #}
{################################################################################}
{# Define the ensemble size, indices start at zero #}
{% set ENS_SIZE = 1 %}

{# GFS and GEFS currently supported #}
{% set ENS_BKG_DATA = 'GEFS' %}

{# Data file frequency for ensemble simulation forcing in HH #}
{% set ENS_BKG_INT = '03' %}

{# Max domain for ensemble simulation #}
{% set WRF_ENS_DOM = '02' %}

{# First domain index to have ICs downscaled from parent's initial conditions (>01) #}
{% set DOWN_DOM = '02' %}

{################################################################################}
{# JOB SETTINGS #}
{################################################################################}
{# ungrib mem argument #}
{% set GRIB_MEM = '20000M' %}

{# Wallclock limit for ungrib jobs #}
{% set GRIB_WC = 'PT30M' %}

{# WPS parallel / REAL number of procs-per-node #}
{% set WPS_PROC = 64 %}

{# WPS mem argument  #}
{% set WPS_MEM = '249000M' %}

{# Number of nodes for WPS parallel / REAL jobs #}
{% set WPS_NDES = 1 %}

{# Wallclock limit for init_atmosphere jobs #}
{% set WPS_WC = 'PT30M' %}

{# WRF model number of procs-per-node #}
{% set WRF_PROC = 128 %}

{# WRF model mem argument #}
{% set WRF_MEM = '249000M' %}

{# Number of nodes for WRF model jobs #}
{% set WRF_NDES = 3 %}

{# Wallclock limit for WRF model #}
{% set WRF_WC = 'PT4H' %}

{# GSI MEM per CPU argument for SLURM #}
{% set GSI_MEM = '21G' %}

{# Number of nodes for GSI jobs #}
{% set GSI_NDES = '1' %}

{# GSI node size #}
{% set GSI_PROC = '124' %}

{# Wallclock limit for GSI jobs #}
{% set GSI_WC = 'PT6H30M' %}

{# Set workflow to debugging mode for generating batch submit templates #}
{% set IF_DBG = 'No' %}

{################################################################################}
{# CYLC SETTINGS #}
{################################################################################}
{# Generating cycle hours from CYC_INC #}
{% set CYC_HRS = [] %}
{% for hr in range(0, 24, CYC_INC) %}
  {% set zhr = hr | pad(2, '0') %}
  {% set zhr = ['T', zhr ] | join('') %}
  {% do CYC_HRS.append(zhr) %}
{% endfor %}


[scheduler]
    UTC mode = True
    allow implicit tasks = True
[scheduling]
    initial cycle point = {{CYC_STRT}}
    final cycle point = {{CYC_STOP}}
    [[graph]]
        R1/^ = """
        ungrib_ens_00_cld  => wrf_metgrid_ens_00_cld
        wrf_metgrid_ens_00_cld => wrf_real_ens_00_cld
        wrf_real_ens_00_cld => wrf_model_ens_00_cld
        """

        R/PT{{CYC_INC}}H/^+{{WRM_UP}} ! ^ = """
        wrf_real_ens_00_cld[-PT{{CYC_INC}}H] |
        wrf_real_ens_00_cyc[-PT{{CYC_INC}}H] => ungrib_ens_00_cyc
        ungrib_ens_00_cyc  => wrf_metgrid_ens_00_cyc
        wrf_metgrid_ens_00_cyc => wrf_real_ens_00_cyc
        (wrf_model_ens_00_cyc[-PT{{CYC_INC}}H] & wrf_real_ens_00_cyc) |
        (wrf_model_ens_00_cld[-PT{{CYC_INC}}H] & wrf_real_ens_00_cyc)=> wrfda_lowbc
        wrfda_lowbc => gsi_analysis
        gsi_analysis => wrfda_latbc
        wrfda_latbc => wrf_model_ens_00_cyc
        """

        {% for zhr in CYC_HRS %}
            {% if zhr in EXT_ZHRS %}
                R/^+{{WRM_UP}}+PT{{CYC_INC}}H+P{{zhr}}H/P1D = """
                wrf_real_ens_00_for[-PT{{CYC_INC}}H] |
                wrf_real_ens_00_cyc[-PT{{CYC_INC}}H] => ungrib_ens_00_for
                ungrib_ens_00_for  => wrf_metgrid_ens_00_for
                wrf_metgrid_ens_00_for => wrf_real_ens_00_for
                (wrf_model_ens_00_cyc[-PT{{CYC_INC}}H] & wrf_real_ens_00_for) |
                (wrf_model_ens_00_for[-PT{{CYC_INC}}H] & wrf_real_ens_00_for)=> wrfda_lowbc
                wrfda_lowbc => gsi_analysis
                gsi_analysis => wrfda_latbc
                wrfda_latbc => wrf_model_ens_00_for
                wrf_model_ens_00_for => wrf_model_ens_00_rstrt
                """
            {% else %}
                R/^+{{WRM_UP}}+PT{{CYC_INC}}H+P{{zhr}}H/P1D = """
                wrf_real_ens_00_for[-PT{{CYC_INC}}H] |
                wrf_real_ens_00_cyc[-PT{{CYC_INC}}H] => ungrib_ens_00_cyc
                ungrib_ens_00_cyc  => wrf_metgrid_ens_00_cyc
                wrf_metgrid_ens_00_cyc => wrf_real_ens_00_cyc
                (wrf_model_ens_00_cyc[-PT{{CYC_INC}}H] & wrf_real_ens_00_cyc) |
                (wrf_model_ens_00_for[-PT{{CYC_INC}}H] & wrf_real_ens_00_cyc)=> wrfda_lowbc
                wrfda_lowbc => gsi_analysis
                gsi_analysis => wrfda_latbc
                wrfda_latbc => wrf_model_ens_00_cyc
                """
            {% endif %}
        {% endfor %}
