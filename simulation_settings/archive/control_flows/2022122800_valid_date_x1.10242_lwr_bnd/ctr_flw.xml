<?xml version="1.0"?>
<!DOCTYPE workflow
[
  <!-- MPAS valid date ensemble workflow -->

  <!-- CONTROL FLOW NAME / TUNABLE SETTINGS -->
  <!ENTITY EXP_VRF      "2022122800"> <!-- Define the valid date YYYYMMDDHH for verification -->
  <!ENTITY DMN_NME      "x1.10242"> <!-- Define the MPAS mesh / refinement name -->
  <!ENTITY CSE_NME      "EnsembleForecastTest"> <!-- Define the name of case study / experiment group -->
  <!ENTITY CNFG_NME     "&EXP_VRF;_valid_date_&DMN_NME;_lwr_bnd"> <!-- Configuration name including tunable parameters -->
  <!ENTITY EXP_NME      "&CSE_NME;/&CNFG_NME;"> <!-- Experiment logs and data are defined in the case / configuration nested structure -->
  <!-- END CONTROL FLOW NAME / TUNABLE SETTINGS -->

  <!-- COMPUTER-DEPENDENT ITEMS -->
  <!ENTITY CLNE_ROOT    "/expanse/nfs/cw3e/cwp157/cgrudzien/JEDI-MPAS-Common-Case/Ensemble-DA-Cycling-Template"> <!-- Full path of framework git clone -->
  <!ENTITY SOFT_ROOT    "/expanse/nfs/cw3e/cwp157/cgrudzien/JEDI-MPAS-Common-Case/SOFT_ROOT"> <!-- Root directory of software stack executables -->
  <!ENTITY DATA_ROOT    "/expanse/lustre/scratch/cgrudzien/temp_project/JEDI-MPAS-Common-Case/DATA"> <!-- Root directory of simulation forcing data -->
  <!ENTITY GRIB_ROOT    "&DATA_ROOT;/GRIB"> <!-- Root directory of grib data data -->
  <!ENTITY WORK_ROOT    "/expanse/lustre/scratch/cgrudzien/temp_project/JEDI-MPAS-Common-Case/SIMULATION_IO/&EXP_NME;"> <!-- Root directory of simulation_io -->
  <!-- END COMPUTER-DEPENDENT -->

  <!-- WORKFLOW SETTINGS  -->
  <!ENTITY EXP_LOG      "&CLNE_ROOT;/logs/&EXP_NME;"> <!-- Root directory of workflow task logs -->
  <!ENTITY EXP_CNFG     "&CLNE_ROOT;/simulation_settings/&EXP_NME;"> <!-- Root directory of experiment configuration files -->
  <!ENTITY SCRIPTS      "&CLNE_ROOT;/scripts"> <!-- Root directory of workflow framework scripts -->
  <!ENTITY DRIVERS      "&SCRIPTS;/drivers"> <!-- Root directory of task driver scripts -->
  <!ENTITY UTILITY      "&SCRIPTS;/utilities"> <!-- Root directory of utility scripts for hacking rocoto to work -->
  <!ENTITY ENVRNMTS     "&SCRIPTS;/environments"> <!-- Root directory of software stack environment scripts -->
  <!-- END WORKFLOW SETTINGS -->

  <!-- SOFTWARE SETTINGS -->
  <!ENTITY WRF_CNST     "&ENVRNMTS;/WRF_constants.sh"> <!-- Full path to WRF software environment sourced file -->
  <!ENTITY MPAS_CNST    "&ENVRNMTS;/MPAS_constants.sh"> <!-- Full path to MPAS software environment sourced file -->
  <!ENTITY WPS_ROOT     "&SOFT_ROOT;/WRF_4.5/WPS/"> <!-- Root directory of WPS clean build -->
  <!ENTITY MPAS_ROOT    "&SOFT_ROOT;/MPAS-Model"> <!-- Root directory of MPAS clean build -->
  <!-- END SOFTWARE SETTINGS -->

  <!-- CYCLING SETTINGS  -->
  <!ENTITY CYC_STRT     "202212270000"> <!-- First initial time for a forecast -->
  <!ENTITY CYC_STOP     "202212270000"> <!-- Last initial time for a forecast -->
  <!ENTITY CYC_INC      "24"> <!-- Interval between cycle start times -->
  <!-- END CYCLING SETTINGS -->

  <!-- ENSEMBLE SETTINGS  -->
  <!ENTITY MEM_LIST     "00"> <!-- list of ensemble perturbation indices -->
  <!ENTITY ENS_BKG_DATA "GEFS"> <!-- GFS and GEFS currently supported -->
  <!ENTITY ENS_BKG_INT  "03"> <!-- Data file frequency for ensemble simulation forcing in HH -->
  <!-- END ENSEMBLE SETTINGS -->

  <!-- MPAS SETTINGS -->
  <!ENTITY HIST_INT     "03"> <!-- Output interval for history files in HH, suppressed = 00 -->
  <!ENTITY DIAG_INT     "03"> <!-- Output interval for diagnostic files in HH, suppressed = 00 -->
  <!ENTITY SND_INT      "00"> <!-- Output interval for sounding files in HH, suppressed = 00 -->
  <!ENTITY RSTRT_INT    "12"> <!-- Output interval for restart files in HH, suppressed = 00 -->
  <!ENTITY IF_RGNL      "No"> <!-- Lateral boundary condition updates from background data -->
  <!ENTITY IF_SST_UPDT  "Yes"> <!-- Lower boundary condition updates from background data -->
  <!ENTITY IF_SST_DIURN "No"> <!-- Diurnal updates to lower boundary conditions -->
  <!ENTITY IF_DEEPSOIL  "No"> <!-- Slowly varying deep soil temperatures -->
  <!ENTITY IF_ZETA_LIST "No"> <!-- If zeta levels are explicitly set -->
  <!ENTITY PIO_NUM      "0"> <!-- Number of tasks devoted to IO, set to 0 for all tasks run IO --> 
  <!ENTITY PIO_STRD     "1"> <!-- Parallel IO stride -->
  <!-- END MPAS SETTINGS -->

  <!-- JOB SETTINGS -->
  <!ENTITY SCHED        "slurm"> <!-- System scheduler, note rocoto interpreter conventions under rocoto/lib/workflowmgr -->
  <!ENTITY PROJECT      "cwp157"> <!-- Project billing account -->
  <!ENTITY PART_CMP     "cw3e-compute"> <!-- Compute queue for standard mpi jobs -->
  <!ENTITY PART_DBG     "cw3e-shared">  <!-- Debug queue for small / rapid parallel jobs -->
  <!ENTITY PART_SRL     "cw3e-shared">  <!-- Serial queue for non-mpi jobs -->
  <!ENTITY MPIRUN       "mpiexec"> <!-- MPI exec command -->
  <!ENTITY GRIB_MEM     "1750M"> <!-- ungrib mem-per-cpu argument -->
  <!ENTITY GRIB_WC      "00:30:00"> <!-- Wallclock limit for ungrib jobs -->
  <!ENTITY INIT_PROC    "64"> <!-- init_atmosphere number of procs-per-node -->
  <!ENTITY INIT_MEM     "1750M"> <!-- init_atmosphere mem-per-cpu argument -->
  <!ENTITY INIT_NDES    "1"> <!-- Number of nodes for init_atmosphere -->
  <!ENTITY INIT_WC      "00:30:00"> <!-- Wallclock limit for init_atmosphere jobs -->
  <!ENTITY MPAS_PROC    "64"> <!-- atmosphere_model number of procs-per-node -->
  <!ENTITY MPAS_MEM     "1750M"> <!-- atmosphere_model mem-per-cpu argument -->
  <!ENTITY MPAS_NDES    "1"> <!-- Number of nodes for atmosphere_model jobs -->
  <!ENTITY MPAS_WC      "00:30:00"> <!-- Wallclock limit for atmosphere_model -->
  <!-- END JOB SETTINGS -->
]>

<workflow realtime="F" scheduler="&SCHED;">
  <!-- DEFINE CYCLE GROUPS -->
  <cycledef group="forecast_cycles">&CYC_STRT; &CYC_STOP; &CYC_INC;:00:00</cycledef>
  <!-- END CYCLE GROUPS -->

  <log verbosity="10"><cyclestr>&EXP_LOG;/@Y@m@d@H/workflow.log</cyclestr></log>
  
  <metatask name="ensemble">
    <var name="ENS_N">&MEM_LIST;</var>  
    <task name="ungrib_ens_#ENS_N#" maxtries="12" cycledefs="forecast_cycles">
      <command>&DRIVERS;/ungrib.sh</command>
      <jobname><cyclestr>ungrib_ens_#ENS_N#_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&EXP_LOG;/@Y@m@d@H/ungrib_ens_#ENS_N#.log</cyclestr></join>
      <walltime>&GRIB_WC;</walltime>
      <partition>&PART_SRL;</partition>
      <account>&PROJECT;</account>
      <nodes>1:ppn=1</nodes>
      <native>--mem-per-cpu=&GRIB_MEM;</native>
      <native>--export=ALL</native>
      <envar>
        <name>CNST</name>
        <value>&WRF_CNST;</value>
      </envar>
      <envar>
         <name>MEMID</name>
         <value>#ENS_N#</value>
      </envar>
      <envar>
        <name>STRT_DT</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>BKG_STRT_DT</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>IF_DYN_LEN</name>
        <value>Yes</value>
      </envar>
      <envar>
        <name>IF_RGNL</name>
        <value>&IF_RGNL;</value>
      </envar>
      <envar>
        <name>IF_SST_UPDT</name>
        <value>&IF_SST_UPDT;</value>
      </envar>
      <envar>
        <name>EXP_VRF</name>
        <value>&EXP_VRF;</value>
      </envar>
      <envar>
        <name>BKG_INT</name>
        <value>&ENS_BKG_INT;</value>
      </envar>
      <envar>
        <name>BKG_DATA</name>
        <value>&ENS_BKG_DATA;</value>
      </envar>
      <envar>
        <name>IF_ECMWF_ML</name>
        <value>No</value>
      </envar>
      <envar>
        <name>WPS_ROOT</name>
        <value>&WPS_ROOT;</value>
      </envar>
      <envar>
        <name>EXP_CNFG</name>
        <value>&EXP_CNFG;</value>
      </envar>
      <envar>
        <name>CYC_HME</name>
        <value><cyclestr>&WORK_ROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>GRIB_ROOT</name>
        <value>&GRIB_ROOT;</value>
      </envar>
    </task>

    <task name="mpas_ic_ens_#ENS_N#" maxtries="12" cycledefs="forecast_cycles">
      <command>&DRIVERS;/mpas_ic.sh</command>
      <jobname><cyclestr>mpas_ic_ens_#ENS_N#_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&EXP_LOG;/@Y@m@d@H/mpas_ic_ens_#ENS_N#.log</cyclestr></join>
      <walltime>&INIT_WC;</walltime>
      <partition>&PART_DBG;</partition>
      <account>&PROJECT;</account>
      <nodes>&INIT_NDES;:ppn=&INIT_PROC;</nodes>
      <native>--mem-per-cpu=&INIT_MEM;</native>
      <native>--export=ALL</native>
      <envar>
        <name>CNST</name>
        <value>&MPAS_CNST;</value>
      </envar>
      <envar>
        <name>DMN_NME</name>
        <value>&DMN_NME;</value>
      </envar>
      <envar>
         <name>MEMID</name>
         <value>#ENS_N#</value>
      </envar>
      <envar>
        <name>STRT_DT</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>IF_DYN_LEN</name>
        <value>Yes</value>
      </envar>
      <envar>
        <name>IF_ZETA_LIST</name>
        <value>&IF_ZETA_LIST;</value>
      </envar>
      <envar>
        <name>EXP_VRF</name>
        <value>&EXP_VRF;</value>
      </envar>
      <envar>
        <name>BKG_DATA</name>
        <value>&ENS_BKG_DATA;</value>
      </envar>
      <envar>
        <name>MPAS_ROOT</name>
        <value>&MPAS_ROOT;</value>
      </envar>
      <envar>
        <name>EXP_CNFG</name>
        <value>&EXP_CNFG;</value>
      </envar>
      <envar>
        <name>CYC_HME</name>
        <value><cyclestr>&WORK_ROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <envar>
        <name>N_NDES</name>
        <value>&INIT_NDES;</value>
      </envar>
      <envar>
        <name>N_PROC</name>
        <value>&INIT_PROC;</value>
      </envar>
      <envar>
        <name>PIO_NUM</name>
        <value>&PIO_NUM;</value>
      </envar>
      <envar>
        <name>PIO_STRD</name>
        <value>&PIO_STRD;</value>
      </envar>
      <dependency> 
        <taskdep task="ungrib_ens_#ENS_N#" state="SUCCEEDED"/>
      </dependency>
    </task>

    <task name="mpas_sfc_ens_#ENS_N#" maxtries="12" cycledefs="forecast_cycles">
      <command>&DRIVERS;/mpas_sfc.sh</command>
      <jobname><cyclestr>mpas_sfc_ens_#ENS_N#_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&EXP_LOG;/@Y@m@d@H/mpas_sfc_ens_#ENS_N#.log</cyclestr></join>
      <walltime>&INIT_WC;</walltime>
      <partition>&PART_DBG;</partition>
      <account>&PROJECT;</account>
      <nodes>&INIT_NDES;:ppn=&INIT_PROC;</nodes>
      <native>--mem-per-cpu=&INIT_MEM;</native>
      <native>--export=ALL</native>
      <envar>
        <name>CNST</name>
        <value>&MPAS_CNST;</value>
      </envar>
      <envar>
        <name>DMN_NME</name>
        <value>&DMN_NME;</value>
      </envar>
      <envar>
         <name>MEMID</name>
         <value>#ENS_N#</value>
      </envar>
      <envar>
        <name>STRT_DT</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>IF_DYN_LEN</name>
        <value>Yes</value>
      </envar>
      <envar>
        <name>IF_ZETA_LIST</name>
        <value>&IF_ZETA_LIST;</value>
      </envar>
      <envar>
        <name>EXP_VRF</name>
        <value>&EXP_VRF;</value>
      </envar>
      <envar>
        <name>BKG_DATA</name>
        <value>&ENS_BKG_DATA;</value>
      </envar>
      <envar>
        <name>BKG_INT</name>
        <value>&ENS_BKG_INT;</value>
      </envar>
      <envar>
        <name>MPAS_ROOT</name>
        <value>&MPAS_ROOT;</value>
      </envar>
      <envar>
        <name>EXP_CNFG</name>
        <value>&EXP_CNFG;</value>
      </envar>
      <envar>
        <name>CYC_HME</name>
        <value><cyclestr>&WORK_ROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <envar>
        <name>N_NDES</name>
        <value>&INIT_NDES;</value>
      </envar>
      <envar>
        <name>N_PROC</name>
        <value>&INIT_PROC;</value>
      </envar>
      <envar>
        <name>PIO_NUM</name>
        <value>&PIO_NUM;</value>
      </envar>
      <envar>
        <name>PIO_STRD</name>
        <value>&PIO_STRD;</value>
      </envar>
      <dependency> 
        <taskdep task="mpas_ic_ens_#ENS_N#" state="SUCCEEDED"/>
      </dependency>
    </task>
    <task name="mpas_model_ens_#ENS_N#" maxtries="12" cycledefs="forecast_cycles">
      <command>&DRIVERS;/mpas_model.sh</command>
      <jobname><cyclestr>mpas_model_ens_#ENS_N#_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&EXP_LOG;/@Y@m@d@H/mpas_model_ens_#ENS_N#.log</cyclestr></join>
      <walltime>&MPAS_WC;</walltime>
      <partition>&PART_CMP;</partition>
      <account>&PROJECT;</account>
      <nodes>&MPAS_NDES;:ppn=&MPAS_PROC;</nodes>
      <native>--mem-per-cpu=&MPAS_MEM;</native>
      <native>--export=ALL</native>
      <envar>
        <name>CNST</name>
        <value>&MPAS_CNST;</value>
      </envar>
      <envar>
        <name>DMN_NME</name>
        <value>&DMN_NME;</value>
      </envar>
      <envar>
         <name>MEMID</name>
         <value>#ENS_N#</value>
      </envar>
      <envar>
        <name>STRT_DT</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>IF_DYN_LEN</name>
        <value>Yes</value>
      </envar>
      <envar>
        <name>EXP_VRF</name>
        <value>&EXP_VRF;</value>
      </envar>
      <envar>
        <name>IF_RGNL</name>
        <value>&IF_RGNL;</value>
      </envar>
      <envar>
        <name>DIAG_INT</name>
        <value>&DIAG_INT;</value>
      </envar>
      <envar>
        <name>HIST_INT</name>
        <value>&HIST_INT;</value>
      </envar>
      <envar>
        <name>SND_INT</name>
        <value>&SND_INT;</value>
      </envar>
      <envar>
        <name>RSTRT_INT</name>
        <value>&RSTRT_INT;</value>
      </envar>
      <envar>
        <name>BKG_INT</name>
        <value>&ENS_BKG_INT;</value>
      </envar>
      <envar>
        <name>IF_RSTRT</name>
        <value>No</value>
      </envar>
      <envar>
        <name>IF_DA</name>
        <value>No</value>
      </envar>
      <envar>
        <name>IF_SST_UPDT</name>
        <value>&IF_SST_UPDT;</value>
      </envar>
      <envar>
        <name>IF_SST_DIURN</name>
        <value>&IF_SST_DIURN;</value>
      </envar>
      <envar>
        <name>IF_DEEPSOIL</name>
        <value>&IF_DEEPSOIL;</value>
      </envar>
      <envar>
        <name>MPAS_ROOT</name>
        <value>&MPAS_ROOT;</value>
      </envar>
      <envar>
        <name>EXP_CNFG</name>
        <value>&EXP_CNFG;</value>
      </envar>
      <envar>
        <name>CYC_HME</name>
        <value><cyclestr>&WORK_ROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <envar>
        <name>N_NDES</name>
        <value>&MPAS_NDES;</value>
      </envar>
      <envar>
        <name>N_PROC</name>
        <value>&MPAS_PROC;</value>
      </envar>
      <envar>
        <name>PIO_NUM</name>
        <value>&PIO_NUM;</value>
      </envar>
      <envar>
        <name>PIO_STRD</name>
        <value>&PIO_STRD;</value>
      </envar>
      <dependency> 
        <taskdep task="mpas_sfc_ens_#ENS_N#" state="SUCCEEDED"/>
      </dependency>
    </task>

  </metatask>
</workflow>
