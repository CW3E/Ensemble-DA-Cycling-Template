<?xml version="1.0"?>
<!DOCTYPE workflow
[
  <!-- GSI Observation-Analysis-Forecast Cycling Workflow -->

  <!-- COMPUTER-DEPENDENT ITEMS -->
  <!ENTITY WORK_SPACE          "/cw3e/mead/projects/cwp130/scratch/cgrudzien">
  <!ENTITY SOFT_SPACE          "/cw3e/mead/projects/cwp130/scratch/cgrudzien">
  <!-- END COMET-DEPENDENT -->

  <!-- USER-DEPENDENT ITEMS -->
  <!ENTITY EMAIL               "cgrudzien@ucsd.edu">
  <!ENTITY USERID              "cgrudzien">
  <!-- END USER-DEPENDENT -->

  <!-- WORKFLOW SETTINGS -->
  <!ENTITY FLOW_NAME           "3denvar_enkf">
  <!ENTITY PROJ_HOME           "&WORK_SPACE;/GSI-WRF-Cycling-Template/Valentine-Case/3D-EnVAR">
  <!ENTITY SCRIPTS             "&PROJ_HOME;/scripts">
  <!ENTITY DRIVERS             "&SCRIPTS;/drivers">
  <!ENTITY ENVIRONMENTS        "&SCRIPTS;/environments">
  <!ENTITY PROJ_DATA           "&PROJ_HOME;/data">
  <!ENTITY LOG                 "&PROJ_DATA;/log/&FLOW_NAME;">
  <!ENTITY INPUT_DATAROOT      "&PROJ_DATA;/cycle_io/&FLOW_NAME;">
  <!ENTITY STATIC_DATA         "&PROJ_DATA;/static">
  <!-- END WORKFLOW SETTINGS -->

  <!-- SOFTWARE SETTINGS -->
  <!ENTITY WPS_SERIAL_ROOT     "&SOFT_SPACE;/WRF_CODE/WRF_4.4/WPS_serial">
  <!ENTITY WPS_PARALLEL_ROOT   "&SOFT_SPACE;/WRF_CODE/WRF_4.4/WPS_parallel">
  <!ENTITY WRF_ROOT            "&SOFT_SPACE;/WRF_CODE/WRF_4.4/WRF">
  <!ENTITY WRFDA_ROOT          "&SOFT_SPACE;/WRF_CODE/WRF_4.4/WRFDA">
  <!ENTITY GSI_ROOT            "&SOFT_SPACE;/GSI_CODE/comGSIv3.7_EnKFv1.3">
  <!ENTITY CRTM_VERSION        "2.3.0">
  <!-- END SOFTWARE SETTINGS -->

  <!-- CYCLING SETTINGS -->
  <!ENTITY CYCLE_START         "201902071800">
  <!ENTITY SECOND_CYCLE        "201902080000">
  <!ENTITY CYCLE_END           "201902080600">
  <!ENTITY CYCLE_INTERVAL      "06:00:00">
  <!ENTITY ENS_LIST            "01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20"> <!-- list of ensemble perturbation indices -->
  <!ENTITY N_ENS               "20"> <!-- Must equal the max index of the ENS_LIST above or 00 if not hybrid DA -->
  <!-- END CYCLING SETTINGS -->

  <!-- UNGRIB SETTINGS -->
  <!ENTITY CTR_BKG_DATA        "GFS"> <!-- GFS and GEFS currently supported for 3D-(En)VAR -->
  <!ENTITY ENS_BKG_DATA        "GEFS"> <!-- GFS and GEFS currently supported for 3D-(En)VAR -->
  <!ENTITY WPS_CONSTANT        "&ENVIRONMENTS;/WPS_constants.sh">
  <!-- END UNGRIB SETTINGS -->

  <!-- WRF SETTINGS -->
  <!ENTITY WRF_CONSTANT        "&ENVIRONMENTS;/WRF_constants.sh">
  <!ENTITY WRF_CTR_DOM         "1"> <!-- Max domain for control simulation -->
  <!ENTITY WRF_ENS_DOM         "1"> <!-- Max domain for ensemble simulation -->
  <!ENTITY WRF_DOWN_DOM        "2"> <!-- Domain index to have ICs downscaled from d01 -->
  <!ENTITY FCST_LENGTH         "06"> <!-- This setting is applied to all WRF preprocessing and WRF -->
  <!ENTITY FCST_INTERVAL       "01">
  <!ENTITY CTR_DATA_INTERVAL   "03"> <!-- This setting is applied to all WRF preprocessing and WRF control run -->
  <!ENTITY ENS_DATA_INTERVAL   "06"> <!-- This setting is applied to all WRF preprocessing and WRF ensemble runs -->
  <!ENTITY IF_SST_UPDATE       "No"> <!-- This setting defines SST updates in simulation and is applied to both WRF and real.exe runs -->
  <!ENTITY IF_FEEDBACK         "No"> <!-- This setting defines 1- or 2-way nesting with WRF domains -->
  <!ENTITY NIO_TPG             "0">  <!-- Set NIO_TPG=0 for default TURN OFF QUILTING --> 
  <!ENTITY NIO_GROUPS          "4"> 
  <!-- END WRF SETTINGS -->

  <!-- GSI SETTINGS -->
  <!ENTITY GSI_CONSTANT        "&ENVIRONMENTS;/GSI_constants.sh">
  <!ENTITY IF_SATRAD           "Yes">
  <!-- END GSI SETTINGS -->
 
  <!-- JOB SETTINGS -->
  <!ENTITY SCHED               "slurm">
  <!ENTITY PROJECT             "--account=cwp130">
  <!ENTITY PARTITION           "--partition=compute"> 
  <!ENTITY MPIRUN              "mpirun">
  <!ENTITY WPS_PROC            "24"> <!-- WPS parallel / REAL procs, all serial hard-coded as 1 -->
  <!ENTITY WPS_MEM             "5G">
  <!ENTITY WPS_NODESIZE        "24">
  <!ENTITY WPS_NODES           "1">
  <!ENTITY WPS_WC              "00:30:00">
  <!ENTITY WRF_PROC            "384">
  <!ENTITY WRF_MEM             "5G">
  <!ENTITY WRF_NODESIZE        "24">
  <!ENTITY WRF_NODES           "16">
  <!ENTITY WRF_WC              "01:30:00">
  <!ENTITY GSI_PROC            "384">
  <!ENTITY GSI_MEM             "5G">
  <!ENTITY GSI_NODESIZE        "24">
  <!ENTITY GSI_NODES           "16">
  <!ENTITY GSI_WC              "01:30:00">
  <!ENTITY GSI_OBSERVER_WC     "04:00:00">
  <!ENTITY ENKF_WC             "01:00:00">
  <!-- END JOB SETTINGS -->
]>

<workflow realtime="F" scheduler="&SCHED;">
  <cycledef group="first_cycle">&CYCLE_START; &CYCLE_START; &CYCLE_INTERVAL;</cycledef>
  <cycledef group="q_daily">&SECOND_CYCLE; &CYCLE_END; &CYCLE_INTERVAL;</cycledef>
  <log verbosity="10"><cyclestr>&LOG;/workflow/workflow_@Y@m@d@H.log</cyclestr></log>
  
  <task name="ungrib_ens_00" maxtries="3" cycledefs="first_cycle,q_daily">
    <command>&DRIVERS;/ungrib.sh</command>
    <cores>1</cores>
    <nodesize>&WPS_NODESIZE;</nodesize>
    <walltime>&WPS_WC;</walltime>
    <jobname><cyclestr>ungrib_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/ungrib/ungrib_ens_00_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&WPS_NODES;</native>
    <native>--mem-per-cpu=&WPS_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&WPS_CONSTANT;</value>
    </envar>
    <envar>
       <name>ENS_N</name>
       <value>00</value>
    </envar>
    <envar>
      <name>BKG_DATA</name>
      <value>&CTR_BKG_DATA;</value>
    </envar>
    <envar>
      <name>FCST_LENGTH</name>
      <value>&FCST_LENGTH;</value>
    </envar>
    <envar>
      <name>DATA_INTERVAL</name>
      <value>&CTR_DATA_INTERVAL;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>BKG_START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>IF_ECMWF_ML</name>
      <value>No</value>
    </envar>
    <envar>
      <name>WPS_ROOT</name>
      <value>&WPS_SERIAL_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <dependency>
      <or>
        <not>
          <cycleexistdep cycle_offset="-&CYCLE_INTERVAL;"/>
        </not>
        <taskdep task="wrf_ens_00" cycle_offset="-&CYCLE_INTERVAL;" state="SUCCEEDED"/>
        <taskdep task="first_wrf_ens_00" cycle_offset="-&CYCLE_INTERVAL;" state="SUCCEEDED"/>
      </or>
    </dependency>
  </task>

  <task name="metgrid_ens_00" maxtries="3" cycledefs="first_cycle,q_daily">
    <command>&DRIVERS;/metgrid.sh</command>
    <cores>&WPS_PROC;</cores>
    <nodesize>&WPS_NODESIZE;</nodesize>
    <walltime>&WPS_WC;</walltime>
    <jobname><cyclestr>metgrid_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/metgrid/metgrid_ens_00_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&WPS_NODES;</native>
    <native>--mem-per-cpu=&WPS_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&WPS_CONSTANT;</value>
    </envar>
    <envar>
       <name>ENS_N</name>
       <value>00</value>
    </envar>
    <envar>
      <name>FCST_LENGTH</name>
      <value>&FCST_LENGTH;</value>
    </envar>
    <envar>
      <name>DATA_INTERVAL</name>
      <value>&CTR_DATA_INTERVAL;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MAX_DOM</name>
      <value>&WRF_CTR_DOM;</value>
    </envar>
    <envar>
      <name>WPS_ROOT</name>
      <value>&WPS_PARALLEL_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MPIRUN</name>
      <value>&MPIRUN;</value>
    </envar>
    <envar>
      <name>WPS_PROC</name>
      <value>&WPS_PROC;</value>
    </envar>
    <dependency> 
      <taskdep task="ungrib_ens_00" state="SUCCEEDED"/>
    </dependency>
  </task>

  <task name="real_ens_00" maxtries="3" cycledefs="first_cycle,q_daily">
    <command>&DRIVERS;/real.sh</command>
    <cores>&WPS_PROC;</cores>
    <nodesize>&WPS_NODESIZE;</nodesize>
    <walltime>&WPS_WC;</walltime>
    <jobname><cyclestr>real_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/real/real_ens_00_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&WPS_NODES;</native>
    <native>--mem-per-cpu=&WPS_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&WRF_CONSTANT;</value>
    </envar>
    <envar>
       <name>ENS_N</name>
       <value>00</value>
    </envar>
    <envar>
      <name>BKG_DATA</name>
      <value>&CTR_BKG_DATA;</value>
    </envar>
    <envar>
      <name>FCST_LENGTH</name>
      <value>&FCST_LENGTH;</value>
    </envar>
    <envar>
      <name>DATA_INTERVAL</name>
      <value>&CTR_DATA_INTERVAL;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MAX_DOM</name>
      <value>&WRF_CTR_DOM;</value>
    </envar>
    <envar>
      <name>IF_SST_UPDATE</name>
      <value>&IF_SST_UPDATE;</value>
    </envar>
    <envar>
      <name>WRF_ROOT</name>
      <value>&WRF_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MPIRUN</name>
      <value>&MPIRUN;</value>
    </envar>
    <envar>
      <name>WPS_PROC</name>
      <value>&WPS_PROC;</value>
    </envar>
    <dependency> 
      <taskdep task="metgrid_ens_00" state="SUCCEEDED"/>
    </dependency>
  </task>

  <metatask name="ensemble_pre_proc">
    <var name="ENS_N">&ENS_LIST;</var>  
    <task name="ungrib_ens_#ENS_N#" maxtries="3" cycledefs="first_cycle,q_daily">
      <command>&DRIVERS;/ungrib.sh</command>
      <cores>1</cores>
      <nodesize>&WPS_NODESIZE;</nodesize>
      <walltime>&WPS_WC;</walltime>
      <jobname><cyclestr>ungrib_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&LOG;/ungrib/ungrib_ens_#ENS_N#_@Y@m@d@H.log</cyclestr></join>
      <native>&PARTITION;</native>
      <native>&PROJECT;</native>
      <native>--export=ALL</native>
      <native>--nodes=&WPS_NODES;</native>
      <native>--mem-per-cpu=&WPS_MEM;</native>
      <envar>
        <name>CONSTANT</name>
        <value>&WPS_CONSTANT;</value>
      </envar>
      <envar>
         <name>ENS_N</name>
         <value>#ENS_N#</value>
      </envar>
      <envar>
        <name>BKG_DATA</name>
        <value>&ENS_BKG_DATA;</value>
      </envar>
      <envar>
        <name>FCST_LENGTH</name>
        <value>&FCST_LENGTH;</value>
      </envar>
      <envar>
        <name>DATA_INTERVAL</name>
        <value>&ENS_DATA_INTERVAL;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>BKG_START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>IF_ECMWF_ML</name>
        <value>No</value>
      </envar>
      <envar>
        <name>WPS_ROOT</name>
        <value>&WPS_SERIAL_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DATA</name>
        <value>&STATIC_DATA;</value>
      </envar>
      <envar>
        <name>INPUT_DATAROOT</name>
        <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <dependency>
        <taskdep task="ungrib_ens_00" state="SUCCEEDED"/>
      </dependency>
    </task>

    <task name="metgrid_ens_#ENS_N#" maxtries="3" cycledefs="first_cycle,q_daily">
      <command>&DRIVERS;/metgrid.sh</command>
      <cores>&WPS_PROC;</cores>
      <nodesize>&WPS_NODESIZE;</nodesize>
      <walltime>&WPS_WC;</walltime>
      <jobname><cyclestr>metgrid_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&LOG;/metgrid/metgrid_ens_#ENS_N#_@Y@m@d@H.log</cyclestr></join>
      <native>&PARTITION;</native>
      <native>&PROJECT;</native>
      <native>--export=ALL</native>
      <native>--nodes=&WPS_NODES;</native>
      <native>--mem-per-cpu=&WPS_MEM;</native>
      <envar>
        <name>CONSTANT</name>
        <value>&WPS_CONSTANT;</value>
      </envar>
      <envar>
         <name>ENS_N</name>
         <value>#ENS_N#</value>
      </envar>
      <envar>
        <name>FCST_LENGTH</name>
        <value>&FCST_LENGTH;</value>
      </envar>
      <envar>
        <name>DATA_INTERVAL</name>
        <value>&ENS_DATA_INTERVAL;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MAX_DOM</name>
        <value>&WRF_ENS_DOM;</value>
      </envar>
      <envar>
        <name>WPS_ROOT</name>
        <value>&WPS_PARALLEL_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DATA</name>
        <value>&STATIC_DATA;</value>
      </envar>
      <envar>
        <name>INPUT_DATAROOT</name>
        <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <envar>
        <name>WPS_PROC</name>
        <value>&WPS_PROC;</value>
      </envar>
      <dependency> 
        <taskdep task="ungrib_ens_#ENS_N#" state="SUCCEEDED"/>
      </dependency>
    </task>

    <task name="real_ens_#ENS_N#" maxtries="3" cycledefs="first_cycle,q_daily">
      <command>&DRIVERS;/real.sh</command>
      <cores>&WPS_PROC;</cores>
      <nodesize>&WPS_NODESIZE;</nodesize>
      <walltime>&WPS_WC;</walltime>
      <jobname><cyclestr>real_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&LOG;/real/real_ens_#ENS_N#_@Y@m@d@H.log</cyclestr></join>
      <native>&PARTITION;</native>
      <native>&PROJECT;</native>
      <native>--export=ALL</native>
      <native>--nodes=&WPS_NODES;</native>
      <native>--mem-per-cpu=&WPS_MEM;</native>
      <envar>
        <name>CONSTANT</name>
        <value>&WRF_CONSTANT;</value>
      </envar>
      <envar>
         <name>ENS_N</name>
         <value>#ENS_N#</value>
      </envar>
      <envar>
        <name>BKG_DATA</name>
        <value>&ENS_BKG_DATA;</value>
      </envar>
      <envar>
        <name>FCST_LENGTH</name>
        <value>&FCST_LENGTH;</value>
      </envar>
      <envar>
        <name>DATA_INTERVAL</name>
        <value>&ENS_DATA_INTERVAL;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MAX_DOM</name>
        <value>&WRF_ENS_DOM;</value>
      </envar>
      <envar>
        <name>IF_SST_UPDATE</name>
        <value>&IF_SST_UPDATE;</value>
      </envar>
      <envar>
        <name>WRF_ROOT</name>
        <value>&WRF_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DATA</name>
        <value>&STATIC_DATA;</value>
      </envar>
      <envar>
        <name>INPUT_DATAROOT</name>
        <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <envar>
        <name>WPS_PROC</name>
        <value>&WPS_PROC;</value>
      </envar>
      <dependency> 
        <taskdep task="metgrid_ens_#ENS_N#" state="SUCCEEDED"/>
      </dependency>
    </task>
  </metatask>

  <task name="wrfda_lowbc" maxtries="3" cycledefs="q_daily">
    <command>&DRIVERS;/wrfda.sh</command>
    <cores>1</cores>
    <nodesize>&WPS_NODESIZE;</nodesize>
    <walltime>&WPS_WC;</walltime>
    <jobname><cyclestr>wrfda_lowbc_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/wrfda/wrfda_lowbc_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&WPS_NODES;</native>
    <native>--mem-per-cpu=&WPS_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&WRF_CONSTANT;</value>
    </envar>
    <envar>
      <name>N_ENS</name>
      <value>&N_ENS;</value>
    </envar>
    <envar>
      <name>ANL_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>IF_ENS_COLD_START</name>
      <value>No</value>
    </envar>
    <envar>
      <name>IF_LOWER</name>
      <value>Yes</value>
    </envar>
    <envar>
      <name>WRF_CTR_DOM</name>
      <value>&WRF_CTR_DOM;</value>
    </envar>
    <envar>
      <name>WRF_ENS_DOM</name>
      <value>&WRF_ENS_DOM;</value>
    </envar>
    <envar>
      <name>WRFDA_ROOT</name>
      <value>&WRFDA_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <dependency> 
      <and>
	<taskdep task="real_ens_00" state="SUCCEEDED"/>
        <metataskdep metatask="ensemble_pre_proc"/>
      </and>
    </dependency>
  </task>

  <task name="gsi_analysis" maxtries="3" cycledefs="q_daily">
    <command>&DRIVERS;/gsi.sh</command>
    <nodesize>&GSI_NODESIZE;</nodesize>
    <cores>&GSI_PROC;</cores>
    <walltime>&GSI_WC;</walltime>
    <jobname><cyclestr>gsi_analysis_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/gsi/gsi_analysis_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&GSI_NODES;</native>
    <native>--mem-per-cpu=&GSI_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&GSI_CONSTANT;</value>
    </envar>
    <envar>
      <name>WRF_CTR_DOM</name>
      <value>&WRF_CTR_DOM;</value>
    </envar>
    <envar>
      <name>WRF_ENS_DOM</name>
      <value>&WRF_ENS_DOM;</value>
    </envar>
    <envar>
      <name>IF_CTR_COLD_START</name>
      <value>No</value>
    </envar>
    <envar>
      <name>IF_ENS_COLD_START</name>
      <value>No</value>
    </envar>
    <envar>
      <name>IF_SATRAD</name>
      <value>&IF_SATRAD;</value>
    </envar>
    <envar>
      <name>IF_HYBRID</name>
      <value>Yes</value>
    </envar>
    <envar>
      <name>IF_OBSERVER</name>
      <value>No</value>
    </envar>
    <envar>
      <name>N_ENS</name>
      <value>&N_ENS;</value>
    </envar>
    <envar>
      <name>IF_4DENVAR</name>
      <value>No</value>
    </envar>
    <envar>
      <name>ANL_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>CRTM_VERSION</name>
      <value>&CRTM_VERSION;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value>&INPUT_DATAROOT;/<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MPIRUN</name>
      <value>&MPIRUN;</value>
    </envar>
    <envar>
      <name>GSI_PROC</name>
      <value>&GSI_PROC;</value>
    </envar>
    <dependency> 
      <taskdep task="wrfda_lowbc" state="SUCCEEDED"/> 
    </dependency>
  </task>

  <task name="gsi_observer" maxtries="3" cycledefs="q_daily">
    <command>&DRIVERS;/gsi.sh</command>
    <nodesize>&GSI_NODESIZE;</nodesize>
    <cores>&GSI_PROC;</cores>
    <walltime>&GSI_OBSERVER_WC;</walltime>
    <jobname><cyclestr>gsi_observer_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/gsi/gsi_observer_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&GSI_NODES;</native>
    <native>--mem-per-cpu=&GSI_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&GSI_CONSTANT;</value>
    </envar>
    <envar>
      <name>WRF_CTR_DOM</name>
      <value>&WRF_CTR_DOM;</value>
    </envar>
    <envar>
      <name>WRF_ENS_DOM</name>
      <value>&WRF_ENS_DOM;</value>
    </envar>
    <envar>
      <name>IF_CTR_COLD_START</name>
      <value>No</value>
    </envar>
    <envar>
      <name>IF_ENS_COLD_START</name>
      <value>No</value>
    </envar>
    <envar>
      <name>IF_SATRAD</name>
      <value>&IF_SATRAD;</value>
    </envar>
    <envar>
      <name>IF_HYBRID</name>
      <value>Yes</value>
    </envar>
    <envar>
      <name>IF_OBSERVER</name>
      <value>Yes</value>
    </envar>
    <envar>
      <name>N_ENS</name>
      <value>&N_ENS;</value>
    </envar>
    <envar>
      <name>IF_4DENVAR</name>
      <value>No</value>
    </envar>
    <envar>
      <name>ANL_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>CRTM_VERSION</name>
      <value>&CRTM_VERSION;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value>&INPUT_DATAROOT;/<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MPIRUN</name>
      <value>&MPIRUN;</value>
    </envar>
    <envar>
      <name>GSI_PROC</name>
      <value>&GSI_PROC;</value>
    </envar>
    <dependency> 
      <taskdep task="gsi_analysis" state="SUCCEEDED"/>
    </dependency>
  </task>

  <task name="enkf" maxtries="3" cycledefs="q_daily">
    <command>&DRIVERS;/enkf.sh</command>
    <nodesize>&GSI_NODESIZE;</nodesize>
    <cores>&GSI_PROC;</cores>
    <walltime>&ENKF_WC;</walltime>
    <jobname><cyclestr>enkf_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/gsi/enkf_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&GSI_NODES;</native>
    <native>--mem-per-cpu=&GSI_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&GSI_CONSTANT;</value>
    </envar>
    <envar>
      <name>N_ENS</name>
      <value>&N_ENS;</value>
    </envar>
    <envar>
      <name>MAX_DOM</name>
      <value>&WRF_ENS_DOM;</value>
    </envar>
    <envar>
      <name>ANL_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>GSI_ROOT</name>
      <value>&GSI_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value>&INPUT_DATAROOT;/<cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MPIRUN</name>
      <value>&MPIRUN;</value>
    </envar>
    <envar>
      <name>GSI_PROC</name>
      <value>&GSI_PROC;</value>
    </envar>
    <dependency> 
      <taskdep task="gsi_observer" state="SUCCEEDED"/>
    </dependency>
  </task>

  <task name="wrfda_latbc" maxtries="3" cycledefs="q_daily">
    <command>&DRIVERS;/wrfda.sh</command>
    <cores>1</cores>
    <nodesize>&WPS_NODESIZE;</nodesize>
    <walltime>&WPS_WC;</walltime>
    <jobname><cyclestr>wrfda_latbc_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/wrfda/wrfda_latbc_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&WPS_NODES;</native>
    <native>--mem-per-cpu=&WPS_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&WRF_CONSTANT;</value>
    </envar>
    <envar>
      <name>N_ENS</name>
      <value>&N_ENS;</value>
    </envar>
    <envar>
      <name>ANL_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>IF_ENS_COLD_START</name>
      <value>No</value>
    </envar>
    <envar>
      <name>IF_LOWER</name>
      <value>No</value>
    </envar>
    <envar>
      <name>WRF_CTR_DOM</name>
      <value>&WRF_CTR_DOM;</value>
    </envar>
    <envar>
      <name>WRF_ENS_DOM</name>
      <value>&WRF_ENS_DOM;</value>
    </envar>
    <envar>
      <name>WRFDA_ROOT</name>
      <value>&WRFDA_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <dependency> 
      <taskdep task="enkf" state="SUCCEEDED"/>
    </dependency>
  </task>

  <task name="first_wrf_ens_00" maxtries="3" cycledefs="first_cycle">
    <command>&DRIVERS;/wrf.sh</command>
    <cores>&WRF_PROC;</cores>
    <nodesize>&WRF_NODESIZE;</nodesize>
    <walltime>&WRF_WC;</walltime>
    <jobname><cyclestr>wrf_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/wrf/wrf_ens_00_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&WRF_NODES;</native>
    <native>--mem-per-cpu=&WRF_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&WRF_CONSTANT;</value>
    </envar>
    <envar>
       <name>ENS_N</name>
       <value>00</value>
    </envar>
    <envar>
      <name>BKG_DATA</name>
      <value>&CTR_BKG_DATA;</value>
    </envar>
    <envar>
      <name>FCST_LENGTH</name>
      <value>&FCST_LENGTH;</value>
    </envar>
    <envar>
      <name>FCST_INTERVAL</name>
      <value>&FCST_INTERVAL;</value>
    </envar>
    <envar>
      <name>DATA_INTERVAL</name>
      <value>&CTR_DATA_INTERVAL;</value>
    </envar>
    <envar>
      <name>CYCLE_INTERVAL</name>
      <value>&CYCLE_INTERVAL;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MAX_DOM</name>
      <value>&WRF_CTR_DOM;</value>
    </envar>
    <envar>
      <name>DOWN_DOM</name>
      <value>&WRF_DOWN_DOM;</value>
    </envar>
    <envar>
      <name>WRF_ROOT</name>
      <value>&WRF_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MPIRUN</name>
      <value>&MPIRUN;</value>
    </envar>
    <envar>
      <name>WRF_PROC</name>
      <value>&WRF_PROC;</value>
    </envar>
    <envar>
      <name>NIO_GROUPS</name>
      <value>&NIO_GROUPS;</value>
    </envar>
    <envar>
      <name>NIO_TPG</name>
      <value>&NIO_TPG;</value>
    </envar>
    <envar>
      <name>IF_CYCLING</name>
      <value>No</value>
    </envar>
    <envar>
      <name>IF_SST_UPDATE</name>
      <value>&IF_SST_UPDATE;</value>
    </envar>
    <envar>
      <name>IF_FEEDBACK</name>
      <value>&IF_FEEDBACK;</value>
    </envar>
    <dependency> 
      <taskdep task="real_ens_00" state="SUCCEEDED"/>
    </dependency>
  </task>

  <task name="wrf_ens_00" maxtries="3" cycledefs="q_daily">
    <command>&DRIVERS;/wrf.sh</command>
    <cores>&WRF_PROC;</cores>
    <nodesize>&WRF_NODESIZE;</nodesize>
    <walltime>&WRF_WC;</walltime>
    <jobname><cyclestr>wrf_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr>&LOG;/wrf/wrf_ens_00_@Y@m@d@H.log</cyclestr></join>
    <native>&PARTITION;</native>
    <native>&PROJECT;</native>
    <native>--export=ALL</native>
    <native>--nodes=&WRF_NODES;</native>
    <native>--mem-per-cpu=&WRF_MEM;</native>
    <envar>
      <name>CONSTANT</name>
      <value>&WRF_CONSTANT;</value>
    </envar>
    <envar>
       <name>ENS_N</name>
       <value>00</value>
    </envar>
    <envar>
      <name>BKG_DATA</name>
      <value>&CTR_BKG_DATA;</value>
    </envar>
    <envar>
      <name>FCST_LENGTH</name>
      <value>&FCST_LENGTH;</value>
    </envar>
    <envar>
      <name>FCST_INTERVAL</name>
      <value>&FCST_INTERVAL;</value>
    </envar>
    <envar>
      <name>DATA_INTERVAL</name>
      <value>&CTR_DATA_INTERVAL;</value>
    </envar>
    <envar>
      <name>CYCLE_INTERVAL</name>
      <value>&CYCLE_INTERVAL;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MAX_DOM</name>
      <value>&WRF_CTR_DOM;</value>
    </envar>
    <envar>
      <name>DOWN_DOM</name>
      <value>&WRF_DOWN_DOM;</value>
    </envar>
    <envar>
      <name>WRF_ROOT</name>
      <value>&WRF_ROOT;</value>
    </envar>
    <envar>
      <name>STATIC_DATA</name>
      <value>&STATIC_DATA;</value>
    </envar>
    <envar>
      <name>INPUT_DATAROOT</name>
      <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MPIRUN</name>
      <value>&MPIRUN;</value>
    </envar>
    <envar>
      <name>WRF_PROC</name>
      <value>&WRF_PROC;</value>
    </envar>
    <envar>
      <name>NIO_GROUPS</name>
      <value>&NIO_GROUPS;</value>
    </envar>
    <envar>
      <name>NIO_TPG</name>
      <value>&NIO_TPG;</value>
    </envar>
    <envar>
      <name>IF_CYCLING</name>
      <value>Yes</value>
    </envar>
    <envar>
      <name>IF_SST_UPDATE</name>
      <value>&IF_SST_UPDATE;</value>
    </envar>
    <envar>
      <name>IF_FEEDBACK</name>
      <value>&IF_FEEDBACK;</value>
    </envar>
    <dependency> 
      <taskdep task="wrfda_latbc" state="SUCCEEDED"/>
    </dependency>
  </task>

  <metatask name="first_ensemble_fore">
    <var name="ENS_N">&ENS_LIST;</var>
    <task name="first_wrf_ens_#ENS_N#" maxtries="3" cycledefs="first_cycle">
      <command>&DRIVERS;/wrf.sh</command>
      <cores>&WRF_PROC;</cores>
      <nodesize>&WRF_NODESIZE;</nodesize>
      <walltime>&WRF_WC;</walltime>
      <jobname><cyclestr>wrf_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&LOG;/wrf/wrf_ens_#ENS_N#_@Y@m@d@H.log</cyclestr></join>
      <native>&PARTITION;</native>
      <native>&PROJECT;</native>
      <native>--export=ALL</native>
      <native>--nodes=&WRF_NODES;</native>
      <native>--mem-per-cpu=&WRF_MEM;</native>
      <envar>
        <name>CONSTANT</name>
        <value>&WRF_CONSTANT;</value>
      </envar>
      <envar>
         <name>ENS_N</name>
         <value>#ENS_N#</value>
      </envar>
      <envar>
        <name>BKG_DATA</name>
        <value>&ENS_BKG_DATA;</value>
      </envar>
      <envar>
        <name>FCST_LENGTH</name>
        <value>&FCST_LENGTH;</value>
      </envar>
      <envar>
        <name>FCST_INTERVAL</name>
        <value>&FCST_INTERVAL;</value>
      </envar>
      <envar>
        <name>DATA_INTERVAL</name>
        <value>&ENS_DATA_INTERVAL;</value>
      </envar>
      <envar>
        <name>CYCLE_INTERVAL</name>
        <value>&CYCLE_INTERVAL;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MAX_DOM</name>
        <value>&WRF_ENS_DOM;</value>
      </envar>
      <envar>
        <name>DOWN_DOM</name>
        <value>&WRF_DOWN_DOM;</value>
      </envar>
      <envar>
        <name>WRF_ROOT</name>
        <value>&WRF_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DATA</name>
        <value>&STATIC_DATA;</value>
      </envar>
      <envar>
        <name>INPUT_DATAROOT</name>
        <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <envar>
        <name>WRF_PROC</name>
        <value>&WRF_PROC;</value>
      </envar>
      <envar>
        <name>NIO_GROUPS</name>
        <value>&NIO_GROUPS;</value>
      </envar>
      <envar>
        <name>NIO_TPG</name>
        <value>&NIO_TPG;</value>
      </envar>
      <envar>
        <name>IF_CYCLING</name>
        <value>No</value>
      </envar>
      <envar>
        <name>IF_SST_UPDATE</name>
        <value>&IF_SST_UPDATE;</value>
      </envar>
      <envar>
        <name>IF_FEEDBACK</name>
        <value>&IF_FEEDBACK;</value>
      </envar>
      <dependency> 
        <taskdep task="real_ens_#ENS_N#" state="SUCCEEDED"/>
      </dependency>
    </task>
  </metatask>

  <metatask name="ensemble_fore">
    <var name="ENS_N">&ENS_LIST;</var>
    <task name="wrf_ens_#ENS_N#" maxtries="3" cycledefs="q_daily">
      <command>&DRIVERS;/wrf.sh</command>
      <cores>&WRF_PROC;</cores>
      <nodesize>&WRF_NODESIZE;</nodesize>
      <walltime>&WRF_WC;</walltime>
      <jobname><cyclestr>wrf_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&LOG;/wrf/wrf_ens_#ENS_N#_@Y@m@d@H.log</cyclestr></join>
      <native>&PARTITION;</native>
      <native>&PROJECT;</native>
      <native>--export=ALL</native>
      <native>--nodes=&WRF_NODES;</native>
      <native>--mem-per-cpu=&WRF_MEM;</native>
      <envar>
        <name>CONSTANT</name>
        <value>&WRF_CONSTANT;</value>
      </envar>
      <envar>
         <name>ENS_N</name>
         <value>#ENS_N#</value>
      </envar>
      <envar>
        <name>BKG_DATA</name>
        <value>&ENS_BKG_DATA;</value>
      </envar>
      <envar>
        <name>FCST_LENGTH</name>
        <value>&FCST_LENGTH;</value>
      </envar>
      <envar>
        <name>FCST_INTERVAL</name>
        <value>&FCST_INTERVAL;</value>
      </envar>
      <envar>
        <name>DATA_INTERVAL</name>
        <value>&ENS_DATA_INTERVAL;</value>
      </envar>
      <envar>
        <name>CYCLE_INTERVAL</name>
        <value>&CYCLE_INTERVAL;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MAX_DOM</name>
        <value>&WRF_ENS_DOM;</value>
      </envar>
      <envar>
        <name>DOWN_DOM</name>
        <value>&WRF_DOWN_DOM;</value>
      </envar>
      <envar>
        <name>WRF_ROOT</name>
        <value>&WRF_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DATA</name>
        <value>&STATIC_DATA;</value>
      </envar>
      <envar>
        <name>INPUT_DATAROOT</name>
        <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <envar>
        <name>WRF_PROC</name>
        <value>&WRF_PROC;</value>
      </envar>
      <envar>
        <name>NIO_GROUPS</name>
        <value>&NIO_GROUPS;</value>
      </envar>
      <envar>
        <name>NIO_TPG</name>
        <value>&NIO_TPG;</value>
      </envar>
      <envar>
        <name>IF_CYCLING</name>
        <value>Yes</value>
      </envar>
      <envar>
        <name>IF_SST_UPDATE</name>
        <value>&IF_SST_UPDATE;</value>
      </envar>
      <envar>
        <name>IF_FEEDBACK</name>
        <value>&IF_FEEDBACK;</value>
      </envar>
      <dependency> 
        <taskdep task="wrfda_latbc" state="SUCCEEDED"/>
      </dependency>
    </task>
  </metatask>

</workflow>
