<?xml version="1.0"?>
<!DOCTYPE workflow
[
  <!-- GSI Observation-Analysis-Forecast Cycling Workflow -->

  <!-- USER-DEPENDENT ITEMS -->
  <!ENTITY PROJ_HOME           "/cw3e/mead/projects/cwp130/scratch/cgrudzien/GSI-WRF-Cycling-Template/Valentine-Case">
  <!ENTITY PROJ_DATA           "&PROJ_HOME;/data">
  <!ENTITY EMAIL               "cgrudzien@ucsd.edu">
  <!ENTITY USERID              "cgrudzien">
  <!ENTITY WPS_ROOT            "/cw3e/mead/projects/cwp130/scratch/cgrudzien/WRF_CODE/WPS_parallel">
  <!ENTITY WRF_ROOT            "/cw3e/mead/projects/cwp130/scratch/cgrudzien/WRF_CODE/WRF">
  <!ENTITY GSI_ROOT            "/cw3e/mead/projects/cwp130/scratch/cgrudzien/comGSIv3.7_EnKFv1.3">
  <!ENTITY CRTM_VERSION        "2.3.0">
  <!-- END USER-DEPENDENT -->

  <!-- WORKFLOW SETTINGS -->
  <!ENTITY LOG                 "&PROJ_DATA;/log">
  <!ENTITY STATIC_DATA         "&PROJ_DATA;/static">
  <!ENTITY INPUT_DATAROOT      "&PROJ_DATA;/cycle_io">
  <!-- END WORKFLOW SETTINGS -

  <!-- CYCLING SETTINGS -->
  <!ENTITY CYCLE_START         "201902090000">
  <!ENTITY CYCLE_END           "201902090000">
  <!ENTITY CYCLE_INTV          "06:00:00">
  <!ENTITY MAX_DOM             "2">
  <!-- END CYCLING SETTINGS --

  <!-- METGRID SETTINGS -->
  <!ENTITY REAL_CONSTANT       "&STATIC_DATA;/WPS_constants.ksh">
  <!ENTITY FCST_LENGTH         "9">
  <!ENTITY DATA_INTERVAL       "06">
  <!-- END METGRID SETTINGS --

  <!-- REAL SETTINGS -->
  <!ENTITY REAL_CONSTANT       "&STATIC_DATA;/WRF_constants.ksh">
  <!ENTITY FCST_LENGTH         "9">
  <!ENTITY DATA_INTERVAL       "06">
  <!-- END REAL SETTINGS -->

  <!-- WRF SETTINGS -->
  <!ENTITY WRF_CONSTANT        "&STATIC_DATA;/WRF_constants.ksh">
  <!ENTITY FCST_LENGTH         "9">
  <!ENTITY FCST_INTERVAL       "01">
  <!ENTITY NIO_TASKS_PER_GROUP "0"> <!-- Set NIO_TASKS_PER_GROUP=0 for default TURN OFF QUILTING --> 
  <!ENTITY NIO_GROUPS          "1"> 
  <!-- END WRF SETTINGS -->

  <!-- GSI SETTINGS -->
  <!ENTITY GSI_CONSTANT        "&STATIC_DATA;/GSI_constants.ksh">
  <!ENTITY IF_SATRAD           "Yes">
  <!ENTITY IF_OBSERVER         "No"> <!-- NOTE, IF_OBSERVER crashes on the test case --> 
  <!ENTITY NO_MEMBER           "20">
  <!ENTITY IF_HYBRID           "No">
  <!ENTITY IF_4DENVAR          "No">
  <!ENTITY IF_NEMSIO           "No">
  <!ENTITY IF_ONEOB            "No">
  <!-- END GSI SETTINGS -->
 
  <!-- JOB SETTINGS -->
  <!ENTITY PROJECT             "cwp130">
  <!ENTITY SCHED               "slurm">
  <!ENTITY COMPUTE             "compute"> 
  <!ENTITY MPIRUN              "mpirun">
  <!ENTITY METGRID_PROC        "24">
  <!ENTITY METGRID_MEM_PER_CPU "5G">
  <!ENTITY METGRID_NODESIZE    "24">
  <!ENTITY METGRID_NODES       "2">
  <!ENTITY METGRID_WC          "02:00:00">
  <!ENTITY REAL_PROC           "24">
  <!ENTITY REAL_MEM_PER_CPU    "5G">
  <!ENTITY REAL_NODESIZE       "24">
  <!ENTITY REAL_NODES          "2">
  <!ENTITY REAL_WC             "02:00:00">
  <!ENTITY WRF_PROC            "24">
  <!ENTITY WRF_MEM_PER_CPU     "5G">
  <!ENTITY WRF_NODESIZE        "24">
  <!ENTITY WRF_NODES           "2">
  <!ENTITY WRF_WC              "02:00:00">
  <!ENTITY GSI_PROC            "24">
  <!ENTITY GSI_MEM_PER_CPU     "5G">
  <!ENTITY GSI_NODESIZE        "24">
  <!ENTITY GSI_NODES           "2">
  <!ENTITY GSI_WC              "02:00:00">
  <!-- END JOB SETTINGS -->
]>

<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="31">
  <cycledef group="q_daily">&CYCLE_START; &CYCLE_END; &CYCLE_INTV;</cycledef>
  <log verbosity="10"><cyclestr>&LOG;/workflow/workflow_@Y@m@d@H.log</cyclestr></log>
    <task name="first_metgrid" maxtries="1" cycledefs="q_daily">
      <command>&STATIC_DATA;/metgrid.ksh</command>
      <cores>&METGRID_PROC;</cores>
      <nodesize>&METGRID_NODESIZE;</nodesize>
      <walltime>&METGRID_WC;</walltime>
      <jobname><cyclestr>first_metgrid_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&LOG;/metgrid/first_metgrid_@Y@m@d@H.log</cyclestr></join>
      <native>--partition=&COMPUTE;</native>
      <native>--account=&PROJECT;</native>
      <native>--export=ALL</native>
      <native>--nodes=&REAL_NODES;</native>
      <native>--mail-type BEGIN</native>
      <native>--mail-type END</native>
      <native>--mail-type=FAIL</native>
      <native>--mail-user=&EMAIL;</native>
      <native>--mem-per-cpu=&METGRID_MEM_PER_CPU;</native>
      <envar>
        <name>CONSTANT</name>
        <value>&METGRID_CONSTANT;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>FCST_LENGTH</name>
        <value>&FCST_LENGTH;</value>
      </envar>
      <envar>
	<name>DATA_INTERVAL</name>
	<value>&DATA_INTERVAL;</value>
      </envar>
      <envar>
        <name>MAX_DOM</name>
        <value>&MAX_DOM;</value>
      </envar>
      <envar>
        <name>WPS_ROOT</name>
        <value>&WPS_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DATA</name>
        <value>&STATIC_DATA;</value>
      </envar>
      <envar>
        <name>INPUT_DATAROOT</name>
        <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <dependency> 
	<streq><left><cyclestr>@Y@m@d@H@M</cyclestr></left><right>&CYCLE_START;</right></streq>
     </dependency>
    </task>
    <task name="first_real" maxtries="1" cycledefs="q_daily">
      <command>&STATIC_DATA;/real.ksh</command>
      <cores>&REAL_PROC;</cores>
      <nodesize>&REAL_NODESIZE;</nodesize>
      <walltime>&REAL_WC;</walltime>
      <jobname><cyclestr>real_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&LOG;/real/first_real_@Y@m@d@H.log</cyclestr></join>
      <native>--partition=&COMPUTE;</native>
      <native>--account=&PROJECT;</native>
      <native>--export=ALL</native>
      <native>--nodes=&REAL_NODES;</native>
      <native>--mail-type BEGIN</native>
      <native>--mail-type END</native>
      <native>--mail-type=FAIL</native>
      <native>--mail-user=&EMAIL;</native>
      <native>--mem-per-cpu=&REAL_MEM_PER_CPU;</native>
      <envar>
        <name>CONSTANT</name>
        <value>&REAL_CONSTANT;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>FCST_LENGTH</name>
        <value>&FCST_LENGTH;</value>
      </envar>
      <envar>
	<name>DATA_INTERVAL</name>
	<value>&DATA_INTERVAL;</value>
      </envar>
      <envar>
        <name>MAX_DOM</name>
        <value>&MAX_DOM;</value>
      </envar>
      <envar>
        <name>WRF_ROOT</name>
        <value>&WRF_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DATA</name>
        <value>&STATIC_DATA;</value>
      </envar>
      <envar>
        <name>INPUT_DATAROOT</name>
        <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <envar>
        <name>REAL_PROC</name>
        <value>&REAL_PROC;</value>
      </envar>
      <dependency> 
	<and>
          <taskdep task="first_metgrid" state="SUCCEEDED"/>
	  <streq><left><cyclestr>@Y@m@d@H@M</cyclestr></left><right>&CYCLE_START;</right></streq>
        </and>
     </dependency>
    </task>
    <task name="first_wrf" maxtries="1" cycledefs="q_daily">
      <command>&STATIC_DATA;/wrf.ksh</command>
      <cores>&WRF_PROC;</cores>
      <nodesize>&WRF_NODESIZE;</nodesize>
      <walltime>&WRF_WC;</walltime>
      <jobname><cyclestr>first_wrf_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&LOG;/wrf/first_wrf_@Y@m@d@H.log</cyclestr></join>
      <native>--partition=&COMPUTE;</native>
      <native>--account=&PROJECT;</native>
      <native>--export=ALL</native>
      <native>--nodes=&WRF_NODES;</native>
      <native>--mail-type BEGIN</native>
      <native>--mail-type END</native>
      <native>--mail-type=FAIL</native>
      <native>--mail-user=&EMAIL;</native>
      <native>--mem-per-cpu=&WRF_MEM_PER_CPU;</native>
      <envar>
        <name>CONSTANT</name>
        <value>&WRF_CONSTANT;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>FCST_LENGTH</name>
        <value>&FCST_LENGTH;</value>
      </envar>
      <envar>
	<name>FCST_INTERVAL</name>
	<value>"00"</value>
      </envar>
      <envar>
	<name>CYCLE_INTV</name>
	<value>&CYCLE_INTV;</value>
      </envar>
      <envar>
        <name>MAX_DOM</name>
        <value>&MAX_DOM;</value>
      </envar>
      <envar>
        <name>WRF_ROOT</name>
        <value>&WRF_ROOT;</value>
      </envar>
      <envar>
        <name>STATIC_DATA</name>
        <value>&STATIC_DATA;</value>
      </envar>
      <envar>
        <name>INPUT_DATAROOT</name>
        <value><cyclestr>&INPUT_DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MPIRUN</name>
        <value>&MPIRUN;</value>
      </envar>
      <envar>
        <name>WRF_PROC</name>
        <value>&WRF_PROC;</value>
      </envar>
      <envar>
        <name>NIO_GROUPS</name>
        <value>&NIO_GROUPS;</value>
      </envar>
      <envar>
        <name>NIO_TASKS_PER_GROUP</name>
        <value>&NIO_TASKS_PER_GROUP;</value>
      </envar>
      <envar>
        <name>IF_CYCLING</name>
        <value>"No"</value>
      </envar>
      <dependency> 
	<and>
          <taskdep task="first_real" state="SUCCEEDED"/>
	  <streq><left><cyclestr>@Y@m@d@H@M</cyclestr></left><right>&CYCLE_START;</right></streq>
        </and>
     </dependency>
    </task>
</workflow>
